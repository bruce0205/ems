<style>
  .title {
    font-weight: 300;
    display: block;
    padding-bottom: 5px;
    position: relative;
    font-weight: bolder;
  }

  .title:before {
    content: "";
    position: absolute;
    width: 100px;
    height: 1px;
    bottom: 0;
    left: -5%;
    border-bottom: 1px solid red;
  }

  .title:after {
    content: "";
    position: absolute;
    width: 250px;
    height: 1px;
    bottom: 0;
    left: 5%;
    border-bottom: 1px solid red;
  }
</style>

<script src="./vendors/jquery-knob/dist/jquery.knob.min.js"></script>
<script src="../build/js/vue.min.js"></script>

<div id="app">
  <div class="right_col" role="main">
    <div class="page-title">
      <div class="title_left">
        <h3>機種管理看板
        </h3>
      </div>

      <div class="title_right">
        <div class="col-md-3 col-sm-3 col-xs-12 form-group pull-right top_search">
          <label for="" style="margin-right: 10px">${now}</label>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
      <div class="col-md-6">
        <div class="x_panel">
          <div class="row">
            <div class="col-md-4">
              <h2>機台：${mahnum}</h2>
            </div>
            <div class="col-md-4">
              <h2>模號：${mold}</h2>
            </div>
            <div class="col-md-4">
              <h2>
                <span class="label label-primary">${status}</span>
              </h2>
            </div>
          </div>
          <div class="row">
            <div class="col-md-8">
              <h2>料號：${pn}</h2>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <h2>穴位：${user_hole}</h2>
            </div>
            <div class="col-md-6">
              <h2>人員：${user_name}</h2>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <h2 class="title">良品數量：${Normal_count}</h2>
              <h2 class="title">不良品數量：${AbNormal_count}</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-sm-6 col-xs-12">
        <div class="x_panel">
          <canvas id="availibilityLineChart"></canvas>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="x_panel">
          <div class="row">
            <div class="col-md-12 text-center">
              <h1>Quality</h1>
              <input class="knob" data-width="150" data-height="150" data-angleOffset=90 data-linecap=round data-fgColor="#26B99A" :value="Quality"
                readonly>
            </div>

          </div>
        </div>
      </div>
      <div class="col-md-6 col-sm-6 col-xs-12">
        <div class="x_panel">
          <canvas id="performanceBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let data = {
    "mahnum": "",
    "mold": "",
    "status": "",
    "pn": "",
    "user_name": "",
    "user_hole": "",
    "Quality": 0,
    "Normal_count": 0,
    "AbNormal_count": 0
  }
  let vm = new Vue({
    delimiters: ['${', '}'],
    el: '#app',
    data,
    created() {
      // api fetch data
      this.fetchData()
    },
    mounted() {
      setTimeout(function () {
        init_knob()
      }, 200)
      this.buildLine()
      this.buildBar()
    },
    methods: {
      fetchData() {
        var url = `/kanban/api/quality/data?mah_num={{mah_num}}`;
        fetch(url, {
          method: 'GET',
          credentials: "same-origin"
        }).then((response) => {
          return response.json();
        }).then((data) => {
          console.log(data)
          if (data.length) {
            this.mahnum = data[0].mahnum
            this.pn = data[0].pn
            this.mold = data[0].mold
            this.status = data[0].status
            this.user_hole = data[0].user_hole
            this.user_name = data[0].user_name
            this.Quality = data[0].Quality
            this.Normal_count = data[0].Normal_count
            this.AbNormal_count = data[0].AbNormal_count
          }
        }).catch((err) => {
          console.error(err);
        });
      },
      buildLine() {
        if ($("#availibilityLineChart").length) {
          var ctx = document.getElementById('availibilityLineChart').getContext('2d');
          var availibilityLineChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['8', '10', '12', '14', '16', '18', '20', '22', '0', '2', '4', '6',],
              datasets: [{
                label: '生產良率',
                data: [90, 92, 89, 90, 92, 91, 94, 95, 92, 91, 89, 94],
                backgroundColor: "#4286f4", // blue
                borderColor: "#4286f4",
                fill: false,
                lineTension: 0.3
              }, {
                label: '目標良率',
                data: [90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90],
                backgroundColor: "#f44141", // red
                borderColor: "#f44141",
                fill: false,
                lineTension: 0.3
              }]
            },
            options: {
              legend: {
                display: true,
                position: 'bottom'
              },
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true,
                    callback: function (value, index, values) {
                      return value + '%';
                    },
                    stepSize: 20
                  },
                  gridLines: {
                    display: true
                  }
                }]
              }
            }
          });
        }
      },
      buildBar() {
        if ($("#performanceBarChart").length) {

          var chartData = {
            labels: ['毛絲', '壓傷', '刮傷', '白污', '亮點', '其他'],
            datasets: [{
              type: 'line',
              id: "y-axis-1",
              label: 'Error Percentage',
              data: [
                6,
                5,
                4,
                3,
                2,
                1
              ],
              backgroundColor: '#9df441', // green
              borderColor: "#9df441",
              fill: false,
              lineTension: 0.3
            }, {
              type: 'bar',
              id: "y-axis-0",
              label: 'Error Count',
              data: [
                12,
                10,
                8,
                6,
                4,
                2
              ],
              backgroundColor: "#ff3236" // red
            }]

          };
          var ctx = document.getElementById('performanceBarChart').getContext('2d');
          var myMixedChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
              responsive: true,
              legend: {
                display: false,
                position: 'bottom'
              },
              title: {
                display: false,
                text: 'Chart.js Combo Bar Line Chart'
              },
              tooltips: {
                mode: 'index',
                intersect: true
              },
              scales: {
                yAxes: [{
                  position: "left",
                  id: "y-axis-0",
                }, {
                  position: "right",
                  id: "y-axis-1",
                  ticks: {
                    max: 10,
                    min: 0,
                    beginAtZero: true,
                    callback: function (value, index, values) {
                      return value + '%';
                    },
                  }
                }]
              }
            }
          });

        }
      }
    },
    computed: {
      now() {
        return moment().format("YYYY-MM-DD HH:mm:ss")
      }
    }
  })


</script>
